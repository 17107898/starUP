<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <title>Scroll Infinito</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    
    <div id="services-container"> </div>
    <!-- Bot√µes para navega√ß√£o vertical -->
    <div class="navigation-buttons-vertical">
        <button class="vertical-prev">‚Üì</button>
        <button class="vertical-next">‚Üë</button>
    </div>
    <div class="sidebar">
        <!-- Logo no topo da sidebar -->
        <div style="text-align: center; margin-bottom: 20px;">
            <img src="{{ url_for('static', filename='images/Empresa.png') }}" alt="Tech Informatic Logo" style="width: 100px; height: auto; height: 100px; border-radius: 50%; border: 2px solid #007bff; cursor: pointer; transition: transform 0.3s ease;">
        </div>
    
        <button id="alterarDescricaoBtn">
            <img src="{{ url_for('static', filename='images/filtro_alterar.png') }}" alt="Alterar Filtro" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 5px;">
            Alterar Descri√ß√£o/Filtro
        </button>
    
        <button id="checarConviteBtn">
            <img src="{{ url_for('static', filename='images/recebido.png') }}" alt="Checar Convite" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 5px;">
            Checar Convite Aceito
            <!-- Bolinha vermelha de notifica√ß√£o -->
            <span id="notificationDot" style="display:none; width: 10px; height: 10px; background-color: red; border-radius: 50%; display: inline-block; vertical-align: middle; margin-left: 5px;"></span>
        </button>
    
        <button id="avaliarPrestadorBtn" onclick="abrirPopupAvaliacao()">
            <img src="{{ url_for('static', filename='images/avaliacao.png') }}" alt="Avaliar Prestador" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 5px;">
            Avaliar Prestador
        </button>
    
        <button id="toggleViewBtn" onclick="toggleView()">
            <img src="{{ url_for('static', filename='images/zoom_mais.png') }}" alt="Ver Imagem Completa" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 5px;">
            Ver Imagem Completa
        </button>
    </div>
    
    
    

<!-- Modal de Avalia√ß√£o do Prestador -->
<div id="popupAvaliacao" class="popup-avaliar">
    <div class="popup-avaliar-content">
        <span class="popup-close" onclick="fecharPopupAvaliacao()">&times;</span>
        <h3 class="titulo-avaliacao">Avaliar Prestador</h3>
    
        <label for="prestadorSelecionadoDropdown">Prestador:</label>
        <select id="prestadorSelecionadoDropdown">
            <!-- Op√ß√µes ser√£o preenchidas dinamicamente com JavaScript -->
        </select>
    
        <!-- Campo para adicionar nota com estrelas -->
        <label>Nota:</label>
        <div class="estrelas-avaliacao" id="estrelasAvaliacao">
            <img src="{{ url_for('static', filename='images/estrela_sem_click.png') }}" alt="1 estrela" data-value="1" onclick="selecionarNota(1)" onmouseover="hoverEstrela(1)" onmouseout="sairEstrela()">
            <img src="{{ url_for('static', filename='images/estrela_sem_click.png') }}" alt="2 estrelas" data-value="2" onclick="selecionarNota(2)" onmouseover="hoverEstrela(2)" onmouseout="sairEstrela()">
            <img src="{{ url_for('static', filename='images/estrela_sem_click.png') }}" alt="3 estrelas" data-value="3" onclick="selecionarNota(3)" onmouseover="hoverEstrela(3)" onmouseout="sairEstrela()">
            <img src="{{ url_for('static', filename='images/estrela_sem_click.png') }}" alt="4 estrelas" data-value="4" onclick="selecionarNota(4)" onmouseover="hoverEstrela(4)" onmouseout="sairEstrela()">
            <img src="{{ url_for('static', filename='images/estrela_sem_click.png') }}" alt="5 estrelas" data-value="5" onclick="selecionarNota(5)" onmouseover="hoverEstrela(5)" onmouseout="sairEstrela()">
        </div>
        <span id="notaTooltip" class="tooltip">Nota: 0</span> <!-- Tooltip para exibir a nota -->
        
    
        <label for="comentarioAvaliacao">Coment√°rio:</label>
        <textarea id="comentarioAvaliacao" placeholder="Escreva seu coment√°rio..."></textarea>
    
        <button onclick="enviarAvaliacao()">Enviar Avalia√ß√£o</button>
    </div>
    
</div>



    
    <!-- Popup de status do convite -->
    <div id="statusConvitePopup" class="popup" style="display:none;">
        <div class="popup-content">
            <span class="popup-close" onclick="fecharPopup()">&times;</span>
            <div id="statusConvite"></div>
        </div>
    </div>
    
    <!-- Overlay para o popup -->
    <div id="modalOverlay" class="modal-overlay" style="display:none;"></div>
    <!-- Modal de Altera√ß√£o de Descri√ß√£o/Filtro -->
<!-- Modal de Altera√ß√£o de Descri√ß√£o/Filtro -->
<div id="alterarDescricaoModal" class="modal hidden">
    <button class="close-btn" onclick="fecharModalAlterarDescricao()">&times;</button>
    <form id="alterarDescricaoForm">
        <label for="serviceType">
            <img src="{{ url_for('static', filename='images/servico-de-gestao.png') }}" alt="Tipo de Servi√ßo" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 5px;">
            Tipo de Servi√ßo:
        </label>
        <select id="serviceType" name="serviceType" required>
            <option value="">Selecione o servi√ßo</option>
            <option value="desenvolvimento_software">Desenvolvimento de Software</option>
            <option value="infraestrutura_ti">Infraestrutura de TI</option>
            <option value="seguranca_cibernetica">Seguran√ßa Cibern√©tica</option>
            <option value="inteligencia_artificial">Intelig√™ncia Artificial</option>
            <option value="cloud_computing">Computa√ß√£o em Nuvem</option>
            <option value="data_science">Ci√™ncia de Dados</option>
            <option value="desenvolvimento_web">Desenvolvimento Web</option>
            <option value="desenvolvimento_mobile">Desenvolvimento Mobile</option>
            <option value="iot">Internet das Coisas (IoT)</option>
            <option value="suporte_tecnico">Suporte T√©cnico</option>
            <option value="automacao_industrial">Automa√ß√£o Industrial</option>
            <option value="devops">DevOps</option>
            <option value="analise_de_dados">An√°lise de Dados</option>            
        </select>

        <label for="novaDescricao">
            <img src="{{ url_for('static', filename='images/politica.png') }}" alt="Descri√ß√£o" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 5px;">
            Nova Descri√ß√£o:
        </label>
        <textarea id="novaDescricao" name="novaDescricao" rows="4"></textarea>

        <label for="urgency">
            <img src="{{ url_for('static', filename='images/urgencia.png') }}" alt="Urg√™ncia" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 5px;">
            Urg√™ncia:
        </label>
        <select id="urgency" name="urgency" required>
            <option value="">Selecione a urg√™ncia</option>
            <option value="urgente">Urgente</option>
            <option value="semana">Dentro de uma semana</option>
            <option value="mes">Dentro de um m√™s</option>
            <option value="sem_prazo">Sem prazo espec√≠fico</option>
        </select>

        <label for="localizacaoImportante">
            <input type="checkbox" id="localizacaoImportante" name="localizacaoImportante">
            <img src="{{ url_for('static', filename='images/localizacao.png') }}" alt="Localiza√ß√£o Importante" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 5px;">
            A Localiza√ß√£o √© importante?
        </label>

        <!-- Campos de endere√ßo que ser√£o exibidos se a localiza√ß√£o for importante -->
        <label for="location">
            <img src="{{ url_for('static', filename='images/CEP.png') }}" alt="CEP" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 5px;">
            CEP (se aplic√°vel):
        </label>
        <input type="text" id="location" name="location" placeholder="Digite o CEP" required>

        <label for="street">
            <img src="{{ url_for('static', filename='images/rua.png') }}" alt="Rua" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 5px;">
            Rua:
        </label>
        <input type="text" id="street" name="street" readonly>

        <label for="neighborhood">
            <img src="{{ url_for('static', filename='images/BAIRRO.png') }}" alt="Bairro" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 5px;">
            Bairro:
        </label>
        <input type="text" id="neighborhood" name="neighborhood" readonly>

        <label for="city">
            <img src="{{ url_for('static', filename='images/CIDADE.png') }}" alt="Cidade" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 5px;">
            Cidade:
        </label>
        <input type="text" id="city" name="city" readonly>

        <label for="state">
            <img src="{{ url_for('static', filename='images/BRASIL_regial.png') }}" alt="Estado" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 5px;">
            Estado:
        </label>
        <input type="text" id="state" name="state" readonly>

        <button type="submit">Salvar Altera√ß√µes</button>
    </form>
</div>
<!-- Popup de confirma√ß√£o de solicita√ß√£o -->
<div id="popupSolicitacao" class="popup-selecao">
    <div class="popup-content-solicitacao">
        <span class="popup-close" onclick="fecharPopupSolicitacao()">&times;</span>
        <h3>Confirmar Solicita√ß√£o de Servi√ßo</h3>

        <div class="solicitacao-details">
            <!-- Tipo de Servi√ßo (n√£o edit√°vel) -->
            <p><strong>Tipo de Servi√ßo:</strong> 
                <span id="tipoServico"></span>
            </p>

            <!-- Descri√ß√£o (n√£o edit√°vel) -->
            <p><strong>Descri√ß√£o:</strong> 
                <span id="descricaoServico"></span>
            </p>

            <!-- Or√ßamento Edit√°vel -->
            <p><strong>Or√ßamento:</strong> 
                <input type="number" id="orcamentoServico" class="editable-field">
            </p>

            <!-- Urg√™ncia Edit√°vel -->
            <p><strong>Urg√™ncia:</strong> 
                <select id="urgenciaServico" class="editable-field">
                    <option value="urgente">Urgente</option>
                    <option value="semana">Dentro de uma semana</option>
                    <option value="mes">Dentro de um m√™s</option>
                    <option value="sem_prazo">Sem prazo espec√≠fico</option>
                </select>
            </p>

            <!-- Localiza√ß√£o (n√£o edit√°vel) -->
            <p><strong>Localiza√ß√£o:</strong> <span id="localizacaoServico"></span></p>
            <p><strong>Rua:</strong> <span id="ruaServico"></span></p>
            <p><strong>Bairro:</strong> <span id="bairroServico"></span></p>
            <p><strong>Cidade:</strong> <span id="cidadeServico"></span></p>
            <p><strong>Estado:</strong> <span id="estadoServico"></span></p>

            <!-- M√©todo de Contato (n√£o edit√°vel) -->
            <p><strong>M√©todo de Contato:</strong> <span id="metodoContatoServico"></span></p>

            <!-- Data de Contato Edit√°vel -->
            <p><strong>Data de Contato:</strong> 
                <input type="date" id="dataContatoServico" class="editable-field">
            </p>

            <!-- Hora de Contato Edit√°vel -->
            <p><strong>Hora de Contato:</strong> 
                <input type="time" id="horaContatoServico" class="editable-field">
            </p>

            <!-- Bot√£o para mostrar a √°rea de mensagem -->
            <p><span class="icon" onclick="toggleMensagem()"> üìù Adicionar mensagem </span></p>

            <!-- √Årea de mensagem escondida inicialmente -->
            <div id="mensagemContainer" style="display: none;">
                <p><strong>Mensagem ao prestador:</strong></p>
                <textarea id="mensagemCliente" class="editable-field" placeholder="Escreva sua mensagem..."></textarea>
            </div>
        </div>

        <!-- Bot√£o de confirma√ß√£o -->
        <!-- Bot√£o de confirma√ß√£o, passando o prestadorId -->
        <button id="confirmarBtn" class="confirmar-servico-btn">Confirmar Solicita√ß√£o</button>
    </div>
</div>


    <!-- Bot√£o para esconder/aparecer a barra lateral -->
    <button id="toggleSidebar">‚óÇ</button>
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script src="{{ url_for('static', filename='js/front.js') }}"></script>
    <script src="{{ url_for('static', filename='js/script_mobie.js') }}"></script>
    <script>
// Fun√ß√£o para alternar a visibilidade da barra lateral
const toggleButton = document.getElementById('toggleSidebar');
const sidebar = document.querySelector('.sidebar');
const zoomIconPath = "{{ url_for('static', filename='images/zoom_mais.png') }}";
const zoomIconPathLess = "{{ url_for('static', filename='images/zoom_menos.png') }}";

toggleButton.addEventListener('click', function() {
    sidebar.classList.toggle('hidden');
    
    if (sidebar.classList.contains('hidden')) {
        toggleButton.innerText = '‚ñ∏'; // Muda para >
        toggleButton.style.left = '10px'; // Mover para o canto
    } else {
        toggleButton.innerText = '‚óÇ'; // Muda para <
        toggleButton.style.left = '200px'; // Voltar para a posi√ß√£o ao lado da barra
    }
});
document.getElementById('alterarDescricaoBtn').addEventListener('click', function () {
    document.getElementById('alterarDescricaoModal').classList.toggle('show');
    // Adicionar classe para desativar o scroll do body
    document.body.classList.add('no-scroll');
});
// Fun√ß√£o para abrir o modal e carregar os dados do servi√ßo
function abrirModalAlterarDescricao(servicoId) {
    fetch(`/api/obter_dados_servico/${servicoId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
                return;
            }
            
            // Preencher os campos com os dados recebidos
            document.getElementById('serviceType').value = data.tipo_servico;
            document.getElementById('novaDescricao').value = data.descricao;
            document.getElementById('urgency').value = data.urgencia;
            document.getElementById('localizacaoImportante').checked = data.localizacao_importante == 1;

            // Se localiza√ß√£o for importante, preencher os campos de localiza√ß√£o
            if (data.localizacao_importante == 1) {
                document.getElementById('location').value = data.cep;
                document.getElementById('street').value = data.rua;
                document.getElementById('neighborhood').value = data.bairro;
                document.getElementById('city').value = data.cidade;
                document.getElementById('state').value = data.estado;
            }

            toggleCamposLocalizacao(data.localizacao_importante == 1);
            document.getElementById('alterarDescricaoModal').classList.remove('hidden');
            
            // Adicionar classe para desativar o scroll do body
            document.body.classList.add('no-scroll');
        })
        .catch(error => {
            console.error('Erro ao carregar os dados do servi√ßo:', error);
        });
}


// Fun√ß√£o para alternar a visibilidade dos campos de localiza√ß√£o
function toggleCamposLocalizacao(localizacaoImportante) {
    const camposLocalizacao = document.querySelectorAll('#location, #street, #neighborhood, #city, #state');
    const labelsLocalizacao = document.querySelectorAll('label[for="location"], label[for="street"], label[for="neighborhood"], label[for="city"], label[for="state"]');

    if (localizacaoImportante) {
        // Se a localiza√ß√£o for importante, exibe os campos e os torna obrigat√≥rios
        camposLocalizacao.forEach(campo => {
            campo.required = true; // Define como obrigat√≥rio
            campo.style.display = 'block'; // Exibe os campos
        });
        labelsLocalizacao.forEach(label => {
            label.style.display = 'block'; // Exibe os labels
        });
    } else {
        // Se a localiza√ß√£o n√£o for importante, oculta os campos e remove a obrigatoriedade
        camposLocalizacao.forEach(campo => {
            campo.required = false; // Remove obrigatoriedade
            campo.style.display = 'none'; // Oculta os campos
            campo.value = ''; // Limpa os valores dos campos
        });
        labelsLocalizacao.forEach(label => {
            label.style.display = 'none'; // Oculta os labels
        });
    }
}

// Evento para mudan√ßa manual do checkbox no formul√°rio
document.getElementById('localizacaoImportante').addEventListener('change', function () {
    toggleCamposLocalizacao(this.checked);
});

// Inicializa o formul√°rio ocultando os campos de localiza√ß√£o
if (!document.getElementById('localizacaoImportante').checked) {
    const camposLocalizacao = document.querySelectorAll('#location, #street, #neighborhood, #city, #state');
    const labelsLocalizacao = document.querySelectorAll('label[for="location"], label[for="street"], label[for="neighborhood"], label[for="city"], label[for="state"]');

    camposLocalizacao.forEach(campo => {
        campo.style.display = 'none'; // Oculta os campos
        campo.removeAttribute('required'); // Remove o atributo required
    });
    labelsLocalizacao.forEach(label => {
        label.style.display = 'none'; // Oculta os labels
    });
}
// Fechar o modal
// Fun√ß√£o para fechar o modal e reativar o scroll
function fecharModalAlterarDescricao() {
    document.getElementById('alterarDescricaoModal').classList.add('hidden');
    document.getElementById('alterarDescricaoModal').classList.remove('show');
    document.body.classList.remove('no-scroll');
}


// Exemplo de chamada ao abrir o modal com o ID do servi√ßo (ajuste conforme sua l√≥gica de frontend)
document.getElementById('alterarDescricaoBtn').addEventListener('click', function() {
    const servicoId = "{{ cliente_id }}";  // O prestador_id vem diretamente da URL
    abrirModalAlterarDescricao(servicoId);
});

// Enviar os dados alterados
document.getElementById('alterarDescricaoForm').addEventListener('submit', async function (event) {
    event.preventDefault();

    const servicoId = "{{ cliente_id }}";  // O cliente vem diretamente da URL
    const tipoServico = document.getElementById('serviceType').value;
    const novaDescricao = document.getElementById('novaDescricao').value;
    const urgencia = document.getElementById('urgency').value;

    const localizacaoImportante = document.getElementById('localizacaoImportante').checked; // Valor do checkbox

    // Verificar se a localiza√ß√£o √© importante, se n√£o for, definir como null
    let location = null;
    let street = null;
    let neighborhood = null;
    let city = null;
    let state = null;

    if (localizacaoImportante) {
        // Coletar valores dos campos de localiza√ß√£o se o checkbox estiver marcado
        location = document.getElementById('location').value;
        street = document.getElementById('street').value;
        neighborhood = document.getElementById('neighborhood').value;
        city = document.getElementById('city').value;
        state = document.getElementById('state').value;
    }

    // Outros campos adicionais, se necess√°rio
    const contactMethod = document.getElementById('contactMethod')?.value || null;
    const contactDate = document.getElementById('contactDate')?.value || null;
    const references = document.getElementById('references')?.files[0] || null;
    const comments = document.getElementById('comments')?.value || null;
    const providerPreferences = document.getElementById('providerPreferences')?.value || null;

    try {
        const formData = new FormData();

        formData.append('tipo_servico', tipoServico);
        formData.append('descricao', novaDescricao);
        formData.append('urgencia', urgencia);
        formData.append('localizacao_importante', localizacaoImportante);
        formData.append('location', location);
        formData.append('street', street);
        formData.append('neighborhood', neighborhood);
        formData.append('city', city);
        formData.append('state', state);
        
        if (contactMethod) formData.append('contactMethod', contactMethod);
        if (contactDate) formData.append('contactDate', contactDate);
        if (references) formData.append('references', references);
        if (comments) formData.append('comments', comments);
        if (providerPreferences) formData.append('providerPreferences', providerPreferences);

        const response = await fetch(`/api/alterar_servico/${servicoId}`, {
            method: 'POST',
            body: formData,
        });

        if (response.ok) {
            alert("Servi√ßo alterado com sucesso!");
            fecharModalAlterarDescricao(); // Fechar o modal ap√≥s a altera√ß√£o

            // Redirecionar o usu√°rio para a p√°gina de login ap√≥s o sucesso da altera√ß√£o
            window.location.href = '/login'; 
        } else {
            alert("Erro ao alterar o servi√ßo.");
        }

    } catch (error) {
        console.error('Erro ao alterar o servi√ßo:', error);
    }
});
function exibirStatusTempo(statusTimestamp, tipoStatus) {
    // Verificar se o timestamp √© v√°lido e tratar como UTC
    const statusDate = new Date(Date.parse(statusTimestamp));
    
    // Caso o statusTimestamp n√£o esteja em um formato correto, o statusDate ser√° "Invalid Date"
    if (isNaN(statusDate)) {
        console.error(`Data inv√°lida recebida: ${statusTimestamp}`);
        return `${tipoStatus}: data inv√°lida`;
    }

    const now = new Date();
    const diffInSeconds = Math.floor((now - statusDate) / 1000);

    let message = "";

    if (diffInSeconds < 60) {
        message = `${tipoStatus} a poucos segundos.`;
    } else if (diffInSeconds < 600) { // menos de 10 minutos
        message = `${tipoStatus} a poucos minutos.`;
    } else if (diffInSeconds < 3600) { // menos de 1 hora
        const minutes = Math.floor(diffInSeconds / 60);
        message = `${tipoStatus} h√° ${minutes} minutos.`;
    } else if (statusDate.toDateString() === now.toDateString()) { // mesmo dia
        const timeString = statusDate.toLocaleTimeString('pt-BR', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: false,
            timeZone: 'UTC'
        });
        message = `${tipoStatus} hoje √†s ${timeString}.`;
    } else if (now.getDate() - statusDate.getDate() === 1 && now.getMonth() === statusDate.getMonth() && now.getFullYear() === statusDate.getFullYear()) {
        // Foi ontem
        const timeString = statusDate.toLocaleTimeString('pt-BR', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: false,
            timeZone: 'UTC'
        });
        message = `${tipoStatus} ontem √†s ${timeString}.`;
    } else {
        const dateFormatted = statusDate.toLocaleDateString('pt-BR');
        const timeString = statusDate.toLocaleTimeString('pt-BR', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: false,
            timeZone: 'UTC'
        });
        message = `${tipoStatus} no dia ${dateFormatted} √†s ${timeString}.`;
    }

    return message;
}





let ultimoStatus = '';
let ultimoLido = '';
let atualizacaoRecebida = false; // Controla se houve uma atualiza√ß√£o nova

// Fun√ß√£o para esconder a bolinha vermelha de notifica√ß√£o
function esconderNotificacao() {
    const notificationElement = document.getElementById('notificationDot');
    notificationElement.style.display = 'none'; // Esconder a bolinha vermelha
}

// Fun√ß√£o para mostrar a bolinha vermelha de notifica√ß√£o
function mostrarNotificacao() {
    const notificationElement = document.getElementById('notificationDot');
    notificationElement.style.display = 'block'; // Mostrar a bolinha vermelha
    atualizacaoRecebida = true; // Marca que h√° uma atualiza√ß√£o para o usu√°rio ver
}

// Fun√ß√£o para checar altera√ß√µes no status e no campo lido
function checarNovidades() {
    fetch('/api/checar_convite')
        .then(response => response.json())
        .then(data => {
            // Se o backend retornar uma lista vazia, n√£o h√° convites
            if (Array.isArray(data) && data.length === 0) {
                console.log("Nenhuma novidade encontrada.");
                esconderNotificacao(); // Esconder notifica√ß√£o se n√£o houver novidades
                return; // N√£o h√° mudan√ßas, sa√≠da da fun√ß√£o
            }

            // Caso o backend retorne um erro
            if (data.error) {
                console.error('Erro ao checar novidades:', data.error);
                esconderNotificacao(); // Esconder notifica√ß√£o se houver erro
                return;
            }

            // Assumindo que data √© uma lista de convites
            const convite = data[0]; // Primeiro convite mais recente
            const status = convite.status;
            const lido = convite.lido ? 'Sim' : 'N√£o';

            // Verificar se houve mudan√ßas no status ou no campo lido
            if (status !== ultimoStatus || lido !== ultimoLido) {
                mostrarNotificacao(); // Mostrar notifica√ß√£o se houver altera√ß√µes
            } else if (!atualizacaoRecebida) {
                // Apenas esconder notifica√ß√£o se n√£o houve atualiza√ß√£o nova e j√° foi vista
                esconderNotificacao();
            }

            // Atualizar os valores
            ultimoStatus = status;
            ultimoLido = lido;
        })
        .catch(error => {
            console.error('Erro ao checar novidades:', error);
            esconderNotificacao(); // Esconder notifica√ß√£o em caso de erro na requisi√ß√£o
        });
}

// Fun√ß√£o para iniciar a checagem autom√°tica a cada 10 segundos
function iniciarChecagemAutomatica() {
    esconderNotificacao(); // Come√ßar com a notifica√ß√£o desativada
    checarNovidades(); // Checar uma vez imediatamente
    setInterval(checarNovidades, 10000); // Checar a cada 10 segundos
}

// Fun√ß√£o para abrir o popup e exibir convites
function abrirPopup() {
    fetch('/api/checar_convite')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
                return;
            }

            // Obter o elemento onde iremos exibir os resultados
            const statusElement = document.getElementById('statusConvite');

            // Limpar o conte√∫do atual do elemento
            statusElement.innerHTML = '';

            // Verificar se h√° dados
            if (data.length === 0) {
                statusElement.innerHTML = 'Nenhum convite encontrado.';
                return;
            }

            // Iterar sobre os convites recebidos e exibir cada um
            data.forEach(convite => {
                const prestadorNome = convite.prestador_nome;
                const fotoPerfil = convite.foto_perfil; // Foto de perfil codificada em Base64
                const status = convite.status;
                const lido = convite.lido ? 'Sim' : 'N√£o';
                const data_visto_prestador = convite.data_visto_prestador || 'N√£o dispon√≠vel';
                const dta_feed_back_prestador = convite.dta_feed_back_prestador || 'N√£o dispon√≠vel';

// √çcones
const aceitoIcon = `<img src="{{ url_for('static', filename='images/Aceito_azul.png') }}" alt="Aceito" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 5px;">`;
const naoAceitoIcon = `<img src="{{ url_for('static', filename='images/n√£o_aceito_azul.png') }}" alt="N√£o Aceito" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 5px;">`;
const vistoIcon = `<img src="{{ url_for('static', filename='images/visualizado.png') }}" alt="Visualizado" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 5px;">`;
const recebidoIcon = `<img src="{{ url_for('static', filename='images/recebido.png') }}" alt="Recebido" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 5px;">`;
const aguardandoIcon = `<img src="{{ url_for('static', filename='images/relogio.png') }}" alt="Aguardando" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 5px;">`; // √çcone do rel√≥gio para "Aguardando resposta"

let vistoMensagem_ = "";
let aceitoMensagem_ = "";

if (data_visto_prestador) {
    vistoMensagem_ = exibirStatusTempo(data_visto_prestador, "");
}

if (dta_feed_back_prestador) {
    aceitoMensagem_ = exibirStatusTempo(dta_feed_back_prestador, "Aceito");
}

let vistoMensagem = "";
if (convite.lido) {
    // Se o convite foi visualizado, mostramos o √≠cone de visualizado com a data de visto
    vistoMensagem = `${vistoIcon} Visto ${vistoMensagem_}`;
    
    // Definir mensagem da resposta com base no status
    aceitoMensagem = status === 'aceito' 
        ? `${aceitoIcon} ${aceitoMensagem_}`
        : status === 'n√£o aceito' 
        ? `${naoAceitoIcon} N√£o aceito` 
        : `${aguardandoIcon} Aguardando resposta`;
} else {
    // Se n√£o foi visualizado, exibe "Aguardando resposta"
    vistoMensagem = `${recebidoIcon} Ainda n√£o visto`;
    aceitoMensagem = `${aguardandoIcon} Aguardando resposta`;
}
// Constru√ß√£o do HTML com a foto de perfil e nome


                statusElement.innerHTML += `
                <div class="convite-item">
                    <p>
                        <strong>Prestador:</strong> 
                        ${fotoPerfil 
                            ? `<img src="data:image/jpeg;base64,${fotoPerfil}" alt="Foto do Prestador" class="foto-perfil" data-prestador-id="${convite.prestador_id}">`
                            : `<img src="{{ url_for('static', filename='images/default-profile.png') }}" alt="Foto Padr√£o" class="foto-perfil" data-prestador-id="${convite.prestador_id}">`
                        } 
                        ${prestadorNome}
                    </p>
                    <p><strong>Convite visto:</strong> ${vistoMensagem}</p>
                    <p><strong>Resposta:</strong> ${aceitoMensagem}</p>
                    <hr>
                </div>
                `;
            });

            // Adicionar os eventos de clique √†s fotos de perfil ap√≥s inser√ß√£o do HTML
            adicionarEventoFotosPerfil();

            // O usu√°rio abriu o popup, ent√£o consideramos que viu as atualiza√ß√µes
            atualizacaoRecebida = false; // Reseta a atualiza√ß√£o recebida
            esconderNotificacao(); // Esconder a notifica√ß√£o quando o popup √© aberto
        })
        .catch(error => console.error('Erro ao checar o status do convite:', error));

    document.getElementById("statusConvitePopup").style.display = "block";
    document.getElementById("modalOverlay").style.display = "block";
}

// Fun√ß√£o para adicionar o evento de clique nas fotos de perfil
function adicionarEventoFotosPerfil() {
    const fotosPerfil = document.querySelectorAll('.foto-perfil');

    fotosPerfil.forEach(foto => {
        foto.addEventListener('click', function () {
            const prestadorId = this.getAttribute('data-prestador-id');
            const urlParams = new URLSearchParams(window.location.search);
            const clienteId = urlParams.get('cliente_id'); // Captura o cliente_id da URL
            
            // Redireciona para a p√°gina do perfil do prestador
            if (prestadorId) {
                window.location.href = `/perfil_prestador?prestador_id=${prestadorId}&cliente_id=${clienteId}`;
            } else {
                alert("Erro: ID do prestador n√£o encontrado.");
            }
        });
    });
}


// Fun√ß√£o para fechar o popup de status e reativar o scroll principal
function fecharPopup() {
    document.getElementById("statusConvitePopup").style.display = "none";
    document.getElementById("modalOverlay").style.display = "none";

    // Remover classe para reativar o scroll do body
    document.body.classList.remove('no-scroll');
}

// Adicionar evento ao bot√£o "Checar Convite Aceito" para abrir o popup
document.getElementById('checarConviteBtn').addEventListener('click', abrirPopup);

// Iniciar a checagem autom√°tica ao carregar a p√°gina
iniciarChecagemAutomatica();


// Quando o bot√£o for clicado, inicia a checagem autom√°tica
document.getElementById('checarConviteBtn').addEventListener('click', function() {
    iniciarChecagemAutomatica();
});


// Fun√ß√£o para formatar o CEP enquanto o usu√°rio digita
function formatarCEP(cep) {
    // Remove todos os caracteres que n√£o sejam n√∫meros
    cep = cep.replace(/\D/g, '');
    
    // Formata o CEP para o padr√£o 'XXXXX-XXX'
    if (cep.length > 5) {
        cep = cep.replace(/^(\d{5})(\d)/, '$1-$2');
    }
    
    return cep;
}

// Fun√ß√£o para buscar o endere√ßo via API do ViaCEP
function buscarEndereco(cep) {
    // Remover caracteres n√£o num√©ricos do CEP
    cep = cep.replace(/\D/g, '');

    // Verificar se o CEP tem 8 d√≠gitos
    if (cep.length !== 8) {
        document.getElementById('response').textContent = 'CEP inv√°lido!';
        return;
    }

    // Fazer a requisi√ß√£o para a API ViaCEP
    fetch(`https://viacep.com.br/ws/${cep}/json/`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Erro ao buscar CEP');
            }
            return response.json();
        })
        .then(data => {
            if (data.erro) {
                document.getElementById('response').textContent = 'CEP n√£o encontrado!';
                return;
            }

            // Preencher os campos com os dados retornados pela API
            document.getElementById('street').value = data.logradouro;
            document.getElementById('neighborhood').value = data.bairro;
            document.getElementById('city').value = data.localidade;
            document.getElementById('state').value = data.uf;
        })
        .catch(error => {
            console.error('Erro:', error);
            document.getElementById('response').textContent = 'Erro ao buscar CEP.';
        });
}

// Adicionar evento ao campo de CEP para formatar enquanto o usu√°rio digita e buscar o endere√ßo automaticamente ao completar 8 d√≠gitos
document.getElementById('location').addEventListener('input', function () {
    const cepInput = document.getElementById('location');
    cepInput.value = formatarCEP(cepInput.value);
    
    // Se o CEP tiver 8 d√≠gitos, buscar o endere√ßo automaticamente
    const cepLimpo = cepInput.value.replace(/\D/g, '');
    if (cepLimpo.length === 8) {
        buscarEndereco(cepLimpo);
    }
});
let prestadorSelecionadoId = null;  // Vari√°vel para armazenar o ID do prestador selecionado
let nomeCliente = null;  // Vari√°vel para armazenar o nome do cliente

// Fun√ß√£o para abrir o popup de avalia√ß√£o e preencher os dados
function abrirPopupAvaliacao() {
    // Fazer uma requisi√ß√£o para pegar os prestadores aceitos
    fetch('/api/pegar_prestadores_aceitos')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
                return;
            }

            const dropdown = document.getElementById('prestadorSelecionadoDropdown');
            dropdown.innerHTML = ''; // Limpar o dropdown

            if (data.length > 0) {
                data.forEach(prestador => {
                    const option = document.createElement('option');
                    option.value = prestador.prestador_id;
                    option.textContent = prestador.nome_prestador;
                    dropdown.appendChild(option);
                });

                prestadorSelecionadoId = dropdown.value;  // Definir o primeiro prestador como selecionado por padr√£o
                nomeCliente = data[0].nome_cliente;  // Salvar o nome do cliente para enviar no feedback
                document.getElementById('popupAvaliacao').style.display = 'flex';
            } else {
                alert('Nenhum prestador aceito encontrado.');
            }

            // Atualizar prestador selecionado quando o dropdown mudar
            dropdown.addEventListener('change', function () {
                prestadorSelecionadoId = this.value;
            });
        })
        .catch(error => console.error('Erro ao pegar prestadores aceitos:', error));
}

// Fun√ß√£o para fechar o popup de avalia√ß√£o e reativar o scroll
function fecharPopupAvaliacao() {
    document.getElementById('popupAvaliacao').style.display = 'none';
    document.body.classList.remove('no-scroll'); // Reativar o scroll do body
}

let notaSelecionada = 0; // Armazena a nota selecionada

// Fun√ß√£o para selecionar uma nota ao clicar em uma estrela
function selecionarNota(nota) {
    notaSelecionada = nota; // Atualiza a nota selecionada
    atualizarVisualizacaoEstrelas(nota); // Atualiza a visualiza√ß√£o das estrelas com a nota clicada
}

// Fun√ß√£o para atualizar a visualiza√ß√£o das estrelas
function atualizarVisualizacaoEstrelas(nota) {
    const estrelas = document.querySelectorAll('#estrelasAvaliacao img');
    estrelas.forEach((estrela, index) => {
        if (index < nota) {
            estrela.src = "{{ url_for('static', filename='images/estrela_estrela_com_click.png') }}"; // Estrela cheia
        } else {
            estrela.src = "{{ url_for('static', filename='images/estrela_sem_click.png') }}"; // Estrela vazia
        }
    });
}

// Fun√ß√£o para mostrar as estrelas preenchidas no hover
function hoverEstrela(nota) {
    atualizarVisualizacaoEstrelas(nota); // Atualiza a visualiza√ß√£o das estrelas com a nota do hover
    exibirNotaTooltip(nota); // Mostra o tooltip com a nota correspondente
}

// Fun√ß√£o para exibir um tooltip com a nota
function exibirNotaTooltip(nota) {
    const tooltip = document.getElementById('notaTooltip');
    tooltip.innerText = `Nota: ${nota}`; // Exibe a nota correspondente
    tooltip.style.display = 'inline'; // Mostra o tooltip
}

// Fun√ß√£o para ocultar o tooltip e restaurar a visualiza√ß√£o das estrelas
function sairEstrela() {
    atualizarVisualizacaoEstrelas(notaSelecionada); // Restaura a visualiza√ß√£o para a nota selecionada
    const tooltip = document.getElementById('notaTooltip');
    tooltip.style.display = 'none'; // Esconde o tooltip
}


// Fun√ß√£o para enviar a avalia√ß√£o
function enviarAvaliacao() {
    const comentario = document.getElementById('comentarioAvaliacao').value;

    if (!prestadorSelecionadoId) {
        alert('Nenhum prestador selecionado.');
        return;
    }

    if (notaSelecionada === 0) {
        alert('Por favor, selecione uma nota.');
        return;
    }

    // Fazer uma requisi√ß√£o para cadastrar o feedback
    fetch('/api/cadastrar_feedback', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            id_prestador: prestadorSelecionadoId,
            nome_cliente: nomeCliente,  // Passa o nome do cliente capturado dinamicamente
            comentario: comentario,
            nota: notaSelecionada
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Erro ao enviar avalia√ß√£o: ' + data.error);
        } else {
            alert('Avalia√ß√£o enviada com sucesso!');
            fecharPopupAvaliacao();  // Fechar o popup ap√≥s o envio
        }
    })
    .catch(error => console.error('Erro ao enviar avalia√ß√£o:', error));
}

    </script>
</body>
</html>
